#!/bin/bash

modules=(./node_modules/*)
home=$(pwd)
dest_root="./www/js"

for x in $(seq 1 ${#modules[@]})
do
  module=${modules[$x]}
  if [[ "$(echo $module | tr -d '[:space:]')" != "" ]]; then
    echo "Converting $module for modular static hosting"
    name=$(echo $module | cut -d'/' -f3)

    cd $module
    root_files=$(find . -maxdepth 1 -name "*.js" -type f)
    sub_files=$(find . -mindepth 2 -name "*.js" -type f)
    cd $home

    root_out="$dest_root/$name.js"
    echo "" > $root_out
    for src in $root_files
    do
      echo "// From $src :\n" >> $root_out
      cat $module/$src >> $root_out
    done

    for src in $sub_files
    do
      # dest="$dest_root"$(echo $src | tr -d '.')
      dest="$dest_root/$src"
      destdir=$(dirname $dest)
      mkdir -p $destdir
      cp -f "$module/$src" $dest
    done
  fi
done
